#!/usr/bin/env bash
#
# Description:
#   Toolchain bootstrap for machine alignment (GNU userland baseline).
#
# Usage:
#   bootstrap.sh                 # check only (default)
#   bootstrap.sh check           # check only
#   bootstrap.sh align --yes     # perform alignment (explicit consent)
#
# Dependencies:
#   bash >= 5.x
#
# Exit codes:
#   0  success
#   2  invalid arguments
#   3  missing dependency
#   10 not aligned

set -euo pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=/dev/null
source "${script_dir}/../lib/common.sh"

# Homebrew installs GNU tools under:
#   "$(brew --prefix)/opt/<formula>/libexec/gnubin"
# Prepending these ensures plain commands resolve to GNU variants (sed/grep/date/find/xargs).
MACOS_GNUBIN_RELATIVE_PATHS=(
  "opt/coreutils/libexec/gnubin" # date, etc.
  "opt/findutils/libexec/gnubin" # find, xargs
  "opt/grep/libexec/gnubin"      # grep
  "opt/gnu-sed/libexec/gnubin"   # sed
  "opt/gawk/libexec/gnubin"      # gawk
)

usage() {
  cat <<EOF
Toolchain bootstrap (v${TOOLCHAIN_VERSION})

Usage:
  $(basename "$0") [check]
  $(basename "$0") align --yes

Commands:
  check     Validate machine alignment (default).
  align     Install/configure required GNU toolchain (requires --yes).

Options:
  --yes     Required for 'align' to confirm you understand changes.

EOF
}

write_env_file() {
  local root="$1"
  local env_file="${root}/.toolchain/env.sh"

  mkdir -p "${root}/.toolchain"

  cat >"${env_file}" <<'EOF'
#!/usr/bin/env bash
# shellcheck shell=bash
# Generated by toolchain bootstrap.
#
# Purpose:
#   Prepend Homebrew "gnubin" directories to PATH so that default command names
#   (sed/grep/date/find/xargs/...) resolve to GNU implementations on macOS.
#
# Notes:
#   - This file intentionally does NOT enable shell options (no "set -u", etc.).
#   - Safe to source from interactive shells (bash/zsh) without breaking prompts.

EOF

  cat >>"${env_file}" <<'EOF'
# Ensure Homebrew bin/sbin are on PATH so `/usr/bin/env bash` resolves to Brew Bash (>= 5.x).
# This also keeps `/usr/bin/env` functional even if user PATH is minimal.
if command -v brew >/dev/null 2>&1; then
  HOMEBREW_PREFIX="$(brew --prefix)"
else
  # Fallbacks for common macOS Homebrew locations.
  if [[ -d "/opt/homebrew" ]]; then
    HOMEBREW_PREFIX="/opt/homebrew"
  else
    HOMEBREW_PREFIX="/usr/local"
  fi
fi
export PATH="${HOMEBREW_PREFIX}/bin:${HOMEBREW_PREFIX}/sbin:${PATH}"
EOF

  chmod +x "${env_file}"
  info "Wrote ${env_file}"
}

append_macos_gnubin_to_env() {
  local root="$1"
  local brew_pfx="$2"
  local env_file="${root}/.toolchain/env.sh"

  local rel
  for rel in "${MACOS_GNUBIN_RELATIVE_PATHS[@]}"; do
    local p="${brew_pfx}/${rel}"
    cat >>"${env_file}" <<EOF
if [[ -d "${p}" ]]; then
  export PATH="${p}:\$PATH"
fi
EOF
  done
}

check_gnu_flavor() {
  local cmd="$1"

  case "$cmd" in
    grep)
      grep --version >/dev/null 2>&1 || return 1
      ;;
    sed)
      sed --version >/dev/null 2>&1 || return 1
      ;;
    date)
      date --version >/dev/null 2>&1 || return 1
      ;;
    find)
      find . --version >/dev/null 2>&1 || return 1
      ;;
    xargs)
      xargs --version >/dev/null 2>&1 || return 1
      ;;
    awk)
      awk 'BEGIN { exit 0 }' </dev/null >/dev/null 2>&1 || return 1
      ;;
    *)
      return 0
      ;;
  esac

  return 0
}

check_alignment() {
  load_config
  bash_version_check "${TOOLCHAIN_REQUIRED_BASH_MAJOR}"

  local missing=0
  local cmd

  for cmd in "${GNU_REQUIRED_COMMANDS[@]}"; do
    if ! command -v "${cmd}" >/dev/null 2>&1; then
      warn "Missing required command: ${cmd}"
      missing=1
      continue
    fi

    if is_macos; then
      if ! check_gnu_flavor "${cmd}"; then
        warn "Non-GNU ${cmd} detected (likely BSD)."
        missing=1
      fi
    fi
  done

  # On macOS, ensure GNU tools are coming from Homebrew gnubin paths (PATH order check)
  if is_macos; then
    local sed_path
    sed_path="$(command -v sed)"
    if [[ "${sed_path}" == "/usr/bin/sed" ]]; then
      warn "GNU sed is installed but PATH is not GNU-first."
      warn "Detected sed: ${sed_path}"
      warn "You must source .toolchain/env.sh or update your shell rc."
      print_alignment_explanation
      return 10
    fi
  fi

  if ((missing == 1)); then
    print_alignment_explanation
    return 10
  fi

  info "Machine alignment OK."
  return 0
}

align_macos() {
  require_cmd brew
  local root
  root="$(cd "${script_dir}/.." && pwd)"

  info "Installing GNU userland + linters via Homebrew..."
  if ! brew list --versions bash >/dev/null 2>&1; then
    brew install bash
  fi
  brew install coreutils findutils grep gnu-sed gawk shellcheck shfmt bats-core

  local brew_pfx
  brew_pfx="$(brew_prefix)"

  write_env_file "${root}"
  append_macos_gnubin_to_env "${root}" "${brew_pfx}"

  info "Alignment complete."
  info "Next step: source .toolchain/env.sh (or add it to your shell rc)."
  info "Example: echo 'source \"${root}/.toolchain/env.sh\"' >> ~/.zshrc"
}

align_linux() {
  local root
  root="$(cd "${script_dir}/.." && pwd)"

  info "Linux alignment: installing required tools via package manager (best effort)."

  if command -v apt-get >/dev/null 2>&1; then
    sudo apt-get update
    sudo apt-get install -y bash coreutils findutils grep sed gawk shellcheck shfmt bats
  elif command -v dnf >/dev/null 2>&1; then
    sudo dnf install -y bash coreutils findutils grep sed gawk ShellCheck shfmt bats
  elif command -v yum >/dev/null 2>&1; then
    sudo yum install -y bash coreutils findutils grep sed gawk ShellCheck shfmt bats
  else
    die "No supported package manager found (apt-get/dnf/yum). Install required tools manually."
  fi

  write_env_file "${root}"
  info "Linux alignment complete (GNU tools are default on Linux)."
}

main() {
  load_config

  local cmd="${1:-check}"
  shift || true

  case "${cmd}" in
    -h | --help | help)
      usage
      ;;
    check)
      check_alignment
      ;;
    align)
      local answer=""
      if [[ "${1:-}" == "--yes" ]]; then
        answer="yes"
        shift || true
      else
        if [[ -t 0 ]]; then
          echo "This will install GNU tools (Homebrew on macOS) and generate .toolchain/env.sh."
          echo "Proceed? [y/N]"
          read -r answer
        else
          echo "ERROR: 'align' requires explicit consent via --yes" >&2
          exit 2
        fi
      fi

      case "${answer}" in
        y | Y | yes | YES) ;;
        *)
          echo "Aborted." >&2
          exit 2
          ;;
      esac

      bash_version_check "${TOOLCHAIN_REQUIRED_BASH_MAJOR}"

      if is_macos; then
        align_macos
      elif is_linux; then
        align_linux
      else
        die "Unsupported OS: $(uname -s)"
      fi

      info "Alignment completed."
      info "IMPORTANT: You must activate the GNU-first PATH in your current shell."
      info "Run: source .toolchain/env.sh"
      info "Then verify with: make check"
      ;;
    *)
      usage
      exit 2
      ;;
  esac
}

main "$@"
