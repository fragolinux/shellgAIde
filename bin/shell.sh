#!/usr/bin/env bash
# Description: Start an interactive "toolchain shell" with the GNU-first env loaded.
# Usage: ./bin/shell.sh [--print-rcfile]
# Dependencies: bash

set -euo pipefail

ROOT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")/.." && pwd -P)"
ENV_FILE_DEFAULT="${ROOT_DIR}/.toolchain/env.sh"
ENV_FILE="${ENV_FILE:-${ENV_FILE_DEFAULT}}"

info() { printf 'INFO: %s\n' "$*" >&2; }
warn() { printf 'WARN: %s\n' "$*" >&2; }
die() {
  printf 'ERROR: %s
' "$*" >&2
  exit 1
}
get_toolchain_version() {
  local v=""
  if [[ -f "${ROOT_DIR}/VERSION" ]]; then
    v="$(head -n1 "${ROOT_DIR}/VERSION" | tr -d '[:space:]' || true)"
  fi
  if [[ -z "${v}" && -f "${ROOT_DIR}/config/toolchain.conf" ]]; then
    # Optional fallback: TOOLCHAIN_VERSION=...
    v="$(grep -E '^TOOLCHAIN_VERSION=' "${ROOT_DIR}/config/toolchain.conf" | head -n1 | cut -d= -f2- | tr -d '"[:space:]' || true)"
  fi
  if [[ -z "${v}" ]]; then
    v="unknown"
  fi
  printf '%s' "${v}"
}

render_rcfile() {
  local version
  version="$(get_toolchain_version)"
  cat <<EOF
# Auto-generated by shellgAIde (toolchain shell). Do not edit.
# This file is *sourced* by bash via --rcfile.

export TOOLCHAIN_SHELL=1
export TOOLCHAIN_ROOT="${ROOT_DIR}"
export TOOLCHAIN_VERSION="${version}"

# Toolchain prompt + clear banners to avoid confusion about nested shells.
PS1='[toolchain ${version}] \u@\h:\w\$ '

echo ">>> ENTERING TOOLCHAIN SHELL (v${version})  root=${ROOT_DIR}"
trap 'echo "<<< LEAVING TOOLCHAIN SHELL (v${version})"' EXIT
EOF
}

load_env() {
  if [[ ! -f "${ENV_FILE}" ]]; then
    die "Env file not found: ${ENV_FILE}. Run: make setup (or make align)"
  fi
  # shellcheck disable=SC1090
  source "${ENV_FILE}"
  info "Toolchain environment loaded (GNU-first PATH)."
}

main() {
  if [[ "${TOOLCHAIN_SHELL:-0}" == "1" ]]; then
    warn "Already inside toolchain shell; not starting a nested shell."
    return 0
  fi

  if [[ "${1:-}" == "--print-rcfile" ]]; then
    render_rcfile
    return 0
  fi

  load_env

  info "Starting toolchain shell (type: exit to return)..."
  local rcfile
  rcfile="$(mktemp -t shellgaide.rc.XXXXXX)"
  render_rcfile >"${rcfile}"
  exec bash --noprofile --rcfile "${rcfile}" -i
}

main "$@"
